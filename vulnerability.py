import streamlit as st
import re

# ---------------- Vulnerability Rules ----------------
VULNERABILITY_RULES = {
    "Use of eval()": r"\beval\(",
    "Use of exec()": r"\bexec\(",
    "Hardcoded password": r"password\s*=\s*[\"'].*[\"']",
    "SQL Injection risk": r"(SELECT|INSERT|UPDATE|DELETE).*\+.*",
    "Command injection risk": r"(os\.system|subprocess\.Popen|os\.popen)\(",
    "Insecure function (C)": r"\bgets\(",
}

# ---------------- Scan Function ----------------
def scan_code(code):
    results = []
    lines = code.splitlines()
    for i, line in enumerate(lines, start=1):
        for vuln, pattern in VULNERABILITY_RULES.items():
            if re.search(pattern, line):
                results.append({
                    "Line": i,
                    "Vulnerability": vuln,
                    "Code": line.strip()
                })
    return results

# ---------------- Streamlit UI ----------------
st.set_page_config(page_title="Vulnerability Analyzer", page_icon="üîç", layout="wide")

# --- Title ---
st.markdown(
    "<h1 style='text-align:center; color:#1976D2;'>Vulnerability Analyzer Tool</h1>",
    unsafe_allow_html=True
)
st.markdown(
    "<p style='text-align:center; font-size:16px;'>Scan your source code for common security vulnerabilities and bad coding patterns.</p>",
    unsafe_allow_html=True
)
st.markdown("---")

# --- Tabs for UI ---
tab_upload, tab_paste = st.tabs(["üìÇ Upload File", "üìù Paste Code"])

code_text = ""

# -------- Upload File Tab --------
with tab_upload:
    st.info("Upload a source code file to scan for vulnerabilities.")
    uploaded_file = st.file_uploader(
        "Choose a file",
        type=["py", "java", "c", "cpp", "js"],
        key="file_upload_tab"
    )

    if uploaded_file:
        code_text = uploaded_file.read().decode("utf-8")
        st.code(code_text, language="")
        if st.button("üîç Scan Uploaded Code", key="scan_file_button"):
            results = scan_code(code_text)
            if results:
                st.subheader("‚ö†Ô∏è Vulnerabilities Detected")
                st.table(results)
            else:
                st.success("‚úÖ No obvious vulnerabilities detected!")

# -------- Paste Code Tab --------
with tab_paste:
    st.info("Paste your source code directly below and scan.")
    code_text = st.text_area("Paste code here", key="paste_code_area")

    if st.button("üîç Scan Pasted Code", key="scan_paste_button"):
        if code_text.strip() == "":
            st.warning("‚ö†Ô∏è Please enter code to scan.")
        else:
            results = scan_code(code_text)
            if results:
                st.subheader("‚ö†Ô∏è Vulnerabilities Detected")
                st.table(results)
            else:
                st.success("‚úÖ No obvious vulnerabilities detected!")

# --- Footer ---
st.markdown("---")
st.caption("Developed for Data Security & Privacy Lab | Enhanced UI Version")
